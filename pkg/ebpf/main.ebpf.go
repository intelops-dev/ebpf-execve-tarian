package ebpf

import (
	"os"

	"github.com/cilium/ebpf"
	"github.com/cilium/ebpf/link"
	"github.com/cilium/ebpf/ringbuf"
)

type Event struct {
	Name       string
	Start_time string
	Hook       Hook
	Data       *interface{}
}

type Hook struct {
	Type    string
	Group   string
	Name    string
	XdpOpts link.XDPOptions
}

type Communication struct {
	StopperChan chan os.Signal
	DataChan    chan *Event
}

type EbpfProgram struct {
	BpfHook    Hook
	BpfProgram *ebpf.Program
	BpfMap     *ebpf.Map
	DataType   interface{}
}

type EbpfHandlers struct {
	evt       Event
	data_type interface{}

	Link      link.Link
	MapReader *ringbuf.Reader

	Comm Communication

	ShouldTerminate bool
}

func (ep EbpfProgram) NewEbpf(com Communication) *EbpfHandlers {
	eh, err := ep.newEbpf(com)
	if err != nil {
		panic(err)
	}

	return eh
}

func (eh *EbpfHandlers) Start() {
	go eh.emit()
	// go eh.sanitize()
}

func (eh *EbpfHandlers) Stop() {
	eh.close()
}
