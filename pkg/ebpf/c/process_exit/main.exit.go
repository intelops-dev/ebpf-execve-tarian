package exit

import (
	e "tarian/pkg/ebpf"

	"github.com/cilium/ebpf/rlimit"
)

//go:generate go run github.com/cilium/ebpf/cmd/bpf2go -cc clang -cflags $BPF_CFLAGS -type event_data exit exit.bpf.c -- -I../../../../headers

func GetEbpfObject() e.EbpfProgram {
	ep := e.EbpfProgram{}

	err := rlimit.RemoveMemlock()
	if err != nil {
		panic(err)
	}

	var bpfObj exitObjects
	err = loadExitObjects(&bpfObj, nil)
	if err != nil {
		panic(err)
	}

	var event exitEventData
	ep.BpfHook = e.Hook{
		Type:  "tracepoint",
		Group: "syscalls",
		Name:  "sys_exit_execve",
	}
	ep.BpfProgram = bpfObj.ExecveExit
	ep.BpfMap = bpfObj.Event
	ep.DataType = &event

	return ep
}
